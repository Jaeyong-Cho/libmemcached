image: openbsd/latest
packages:
  - bison
  - cmake
  - cyrus-sasl--
  - libevent
  - memcached--
  - pkgconf
  - py3-sphinx
  - py3-m2r
  - rsync
  - sudo--
  - tbb
sources:
  - https://github.com/m6w6/libmemcached
environment:
  ENABLE_HASH_HSIEH:  "ON"
  ENABLE_MEMASLAP:    "OFF"
  VERBOSE:            "ON"
  MEMCACHED_BINARY:   "memcached"
tasks:
  - configure: |
      cmake -DCMAKE_BUILD_TYPE=Debug -DBUILD_TESTING=ON -S libmemcached -B debug
  - build: |
      cmake --build debug -j2
  - test: |
      cmake --build debug -j2 --target test
  - install: |
      cmake --build debug -j2 --target install -- DESTDIR=/tmp
  - package: |
      cmake -DCMAKE_BUILD_TYPE=Release -DBUILD_DOCS_MANGZ=ON -S libmemcached -B release
      cmake --build release -j2 --target package -- VERBOSE=
      cmake --build release -j2 --target push-artifact -- VERBOSE=

