services:
 - memcached

addons:
 apt:
  packages:
   - python-sphinx
   - valgrind
   - libevent-dev
   - libsasl2-dev

dist: bionic
language: cpp
compiler:
 - gcc
 - clang

env:
# - BUILD=Release SASL=false
# - BUILD=Debug SASL=false
 - BUILD=Debug SASL=true MEMCACHED_BINARY=/opt/bin/memcached MEMCACHED_PORT=11212

#before_install:
install:
 - |
   if ${SASL};
   then
     git clone -b 1.5.9 https://github.com/memcached/memcached &&
     cd memcached &&
     CFLAGS="-O2 -pipe" ./configure --prefix=/opt --disable-dependency-tracking --enable-sasl --enable-sasl-pwdb --disable-coverage --disable-docs &&
     make && make install &&
     /opt/bin/memcached -l 127.0.0.1 -p ${MEMCACHED_PORT} -U ${MEMCACHED_PORT} -m 128 &
   fi

before_script:
 - echo stats settings | nc -q 0 localhost ${MEMCACHED_PORT:11211} | column -t
 - mkdir build

script:
 - cd build
 - cmake -DCMAKE_BUILD_TYPE=${BUILD} -DENABLE_SASL=${SASL} -DMEMCACHED_BINARY=${MEMCACHED_BINARY:/usr/bin/memcached} ..
 - make
 - make test
 - make install DESTDIR=.

#before_cache:
#after_success:

after_failure:
 - cat Testing/Temporary/LastTest.log

#after_script:
